<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Private Voting System</title>
  <style>
    :root {
      --primary: #1e90ff;
      --success: #4CAF50;
      --danger: #f44336;
      --warning: #ff9800;
      --dark: #121212;
      --darker: #0a0a0a;
      --darkest: #050505;
      --light: #f5f5f5;
      --gray: #333;
      --light-gray: #bbb;
    }
    
    body { 
      background: var(--darkest); 
      color: white; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      padding: 0;
      margin: 0;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      margin: 8px 5px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .btn-primary {
      background: var(--primary);
    }
    
    .btn-success {
      background: var(--success);
    }
    
    .btn-danger {
      background: var(--danger);
    }
    
    .btn-warning {
      background: var(--warning);
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-outline:hover {
      background: rgba(30, 144, 255, 0.1);
    }
    
    .btn:disabled {
      background: var(--gray);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.7;
    }
    
    .panel {
      margin-top: 30px;
      padding: 25px;
      border-radius: 12px;
      background: var(--darker);
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    input, textarea {
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid var(--gray);
      background: rgba(255,255,255,0.05);
      color: white;
      width: 100%;
      max-width: 500px;
      font-size: 16px;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(30, 144, 255, 0.3);
    }
    
    img {
      border-radius: 10px;
      object-fit: cover;
    }
    
    .candidate-item {
      display: flex;
      align-items: center;
      margin: 20px 0;
      padding: 20px;
      background: rgba(255,255,255,0.03);
      border-radius: 10px;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }
    
    .candidate-item:hover {
      background: rgba(255,255,255,0.05);
      border-left-color: var(--primary);
    }
    
    .candidate-item img {
      width: 80px;
      height: 80px;
      margin-right: 20px;
    }
    
    .candidate-info {
      flex: 1;
    }
    
    .candidate-info h3 {
      margin: 0;
      font-size: 1.3em;
      color: white;
    }
    
    .candidate-info p {
      margin: 8px 0;
      color: var(--light-gray);
    }
    
    .vote-count {
      font-weight: bold;
      color: var(--primary);
      background: rgba(30, 144, 255, 0.1);
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.9em;
    }
    
    h1, h2, h3 {
      color: white;
    }
    
    h1 {
      text-align: center;
      color: #00ff00;
      text-shadow: 0 0 10px rgba(0, 255, 0, 0.3), 0 0 20px rgba(0, 255, 0, 0.2);
      font-size: 2.5em;
      margin-bottom: 30px;
      padding-top: 20px;
    }
    
    h2 {
      margin-top: 0;
      font-size: 1.8em;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 10px;
    }
    
    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top: 4px solid var(--success);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 30px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .auth-status {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    
    .google-icon {
      width: 20px;
      height: 20px;
      margin-right: 8px;
    }
    
    .action-buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .notice {
      background: rgba(76, 175, 80, 0.1);
      border-left: 4px solid var(--success);
      padding: 15px;
      border-radius: 0 8px 8px 0;
      margin: 20px 0;
    }
    
    .notice a {
      color: var(--success);
      text-decoration: none;
      font-weight: bold;
    }
    
    .notice a:hover {
      text-decoration: underline;
    }
    
    .winner-banner {
      background: linear-gradient(135deg, rgba(76,175,80,0.2), rgba(76,175,80,0.4));
      border-left: 4px solid var(--success);
      padding: 15px;
      border-radius: 0 8px 8px 0;
      margin: 20px 0;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
      100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
    }
    
    .winner-name {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--success);
      margin: 10px 0;
    }
    
    .header {
      background: var(--dark);
      padding: 20px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    .voting-disabled {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .admin-only {
      background: rgba(244, 67, 54, 0.1);
      border-left: 4px solid var(--danger);
      padding: 10px;
      border-radius: 0 8px 8px 0;
      margin: 10px 0;
      font-size: 0.9em;
    }
  </style>
</head>
<body>

<!-- Popup Guide -->
<div id="popup" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000000dd;z-index:9999;display:flex;justify-content:center;align-items:center;flex-direction:column;text-align:center;padding:20px;">
  <h2 style="color:lightgreen;">üó≥Ô∏è Voting System ‚Äì Quick User Guide</h2>
  <p><strong>üîê Login</strong><br>Click "Sign in with DIU Mail to Vote".<br>Use your DIU email only.</p>
  <p><strong>‚úÖ Vote</strong><br>Choose a candidate.<br>Click "Vote" ‚Üí Confirm.<br>Sign in again to verify ‚Üí Done!<br>Message: "Thank you for voting..."</p>
  <p><strong>‚ö†Ô∏è‚ö†Ô∏è You can vote only once.</strong></p>
  <p class="loading-message">‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è The server is a bit slow‚Äîplease wait a moment after clicking any button.</p>
  <p><strong>üì¢ Results</strong><br>Visit the Notice Board:<br><a href="https://mizan658.github.io/AL/notice.html" style="color:lightblue;">https://mizan658.github.io/AL/notice.html</a></p>
  <button onclick="document.getElementById('popup').style.display='none'" style="margin-top:20px;background:#4caf50;border:none;padding:12px 24px;border-radius:8px;color:white;cursor:pointer;font-weight:bold;">I Understand</button>
  <div class="contact-mail" style="margin-top:20px;">Contact Mail: <a href="mailto:help.to.tz@gmail.com" style="color:#00ffff">help.to.tz@gmail.com</a></div>
</div>

<div class="header">
  <div class="container">
    <h1>Welcome to Private Voting System</h1>

    <div class="action-buttons">
      <div>
        <button class="btn btn-primary" onclick="signInUser()">
          <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" class="google-icon">
          Sign in with DIU Mail to Vote
        </button>
        <button onclick="window.location.href='https://mizan658.github.io/AL/notice.html'" class="btn btn-outline">Notice</button>
        <button onclick="window.location.href='https://mizan658.github.io/AL/index.html'" class="btn btn-outline">Home</button>
      </div>
      <button class="btn btn-danger" onclick="signInAdmin()">Admin Panel Login</button>
    </div>
  </div>
</div>

<div class="container">
  <div id="winnerSection" class="panel" style="display:none;">
    <h2>üèÜ Election Results</h2>
    <div id="winnerContent"></div>
  </div>

  <div id="adminPanel" class="panel" style="display:none;">
    <h2>Admin Panel</h2>
    
    <div class="admin-only">
      <h3>Election Controls</h3>
      <button class="btn btn-success" onclick="publishWinner()">Publish Winner</button>
      <button class="btn btn-warning" onclick="resetVoting()">Reset Voting</button>
      <p style="margin-top:10px;"><small>Publishing winner will end the election and show results to everyone.</small></p>
    </div>
    
    <h3>Manage Candidates</h3>
    <input type="text" id="candidateName" placeholder="Candidate Name">
    <input type="text" id="candidatePhoto" placeholder="Photo URL">
    <textarea id="candidateBio" placeholder="Candidate Bio" rows="4"></textarea>
    <button class="btn btn-success" onclick="addCandidate()">Add Candidate</button>

    <div id="adminCandidateList"></div>

    <h3>Vote Statistics</h3>
    <button class="btn btn-primary" onclick="loadVotesAdmin()">Refresh Votes</button>
    <div id="voteListAdmin"></div>
  </div>

  <div id="voteSection" class="panel" style="display:none;">
    <div id="authStatus" class="auth-status"></div>
    <h2>Vote for Your Candidate</h2>
    <div id="loading" class="loading-spinner" style="display:none;"></div>
    <div id="voteList"></div>
  </div>

  <div id="candidatesListPublic" class="panel">
    <h2>Candidates</h2>
    <div id="publicAuthStatus"></div>
    <div id="loadingPublic" class="loading-spinner"></div>
    <div id="publicCandidatesList"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCQaeFbaXbeJkw08N3of2Xiu3hMfiW8wTk",
    authDomain: "voting-app-2b276.firebaseapp.com",
    projectId: "voting-app-2b276",
    storageBucket: "voting-app-2b276.appspot.com",
    messagingSenderId: "699531517654",
    appId: "1:699531517654:web:785702f843d21a85c17377",
    measurementId: "G-309D0KG6KL"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // Track current user and election status
  let currentUser = null;
  let electionStatus = { isActive: true, winner: null };

  // Initialize the app
  async function initApp() {
    await checkElectionStatus();
    onAuthStateChanged(auth, handleAuthChange);
  }

  // Check election status from Firestore
  async function checkElectionStatus() {
    const statusDoc = await getDoc(doc(db, "election", "status"));
    if (statusDoc.exists()) {
      electionStatus = statusDoc.data();
      updateElectionUI();
    }
  }

  // Update UI based on election status
  function updateElectionUI() {
    const winnerSection = document.getElementById("winnerSection");
    const winnerContent = document.getElementById("winnerContent");
    
    if (!electionStatus.isActive && electionStatus.winner) {
      winnerSection.style.display = "block";
      winnerContent.innerHTML = `
        <div class="winner-banner">
          <h3>The election has concluded</h3>
          <p>The winner is:</p>
          <div class="winner-name">${electionStatus.winner.name}</div>
          <img src="${electionStatus.winner.photoURL}" width="150" style="border-radius:50%; margin:10px 0;">
          <p>${electionStatus.winner.bio}</p>
          <p>Total votes: ${electionStatus.winner.votes}</p>
        </div>
      `;
      
      // Disable voting UI
      document.getElementById("voteSection").style.display = "none";
      document.getElementById("candidatesListPublic").classList.add("voting-disabled");
    } else {
      winnerSection.style.display = "none";
      document.getElementById("candidatesListPublic").classList.remove("voting-disabled");
    }
  }

  // Handle authentication state changes
  async function handleAuthChange(user) {
    currentUser = user;
    updateAuthUI();
    
    if (user) {
      if (user.email === "252-35-007@diu.edu.bd") {
        document.getElementById("adminPanel").style.display = "block";
        loadAdminCandidates();
        loadVotesAdmin();
      } else if (user.email.endsWith("@diu.edu.bd") && electionStatus.isActive) {
        document.getElementById("voteSection").style.display = "block";
        loadVotes(user.uid);
      }
    } else {
      document.getElementById("adminPanel").style.display = "none";
      document.getElementById("voteSection").style.display = "none";
    }
    
    loadPublicCandidates();
  }

  // Update authentication UI
  function updateAuthUI() {
    const authStatus = document.getElementById("authStatus");
    const publicAuthStatus = document.getElementById("publicAuthStatus");
    
    if (currentUser) {
      authStatus.innerHTML = `
        <img src="${currentUser.photoURL || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" class="user-avatar">
        <span>Signed in as ${currentUser.email}</span>
        <button class="btn btn-danger" onclick="signOutUser()" style="margin-left:auto;">Sign Out</button>
      `;
      
      if (currentUser.email.endsWith("@diu.edu.bd")) {
        publicAuthStatus.innerHTML = electionStatus.isActive ? `
          <div class="notice">
            You are signed in. You can now vote for your preferred candidate.
          </div>
        ` : `
          <div class="notice">
            The election has ended. Thank you for participating.
          </div>
        `;
      } else {
        publicAuthStatus.innerHTML = `
          <div style="color:var(--danger); padding:10px; background:rgba(244,67,54,0.1); border-radius:8px;">
            Only DIU emails are allowed to vote. You are signed in with ${currentUser.email}
          </div>
        `;
      }
    } else {
      authStatus.innerHTML = `
        <button class="btn btn-primary" onclick="signInUser()">
          <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" class="google-icon">
          Sign in with DIU Mail to Vote
        </button>
      `;
      
      publicAuthStatus.innerHTML = electionStatus.isActive ? `
        <button class="btn btn-primary" onclick="signInUser()" style="width:100%;">
          <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" class="google-icon">
          Sign in with DIU Mail to Vote
        </button>
        <p style="text-align:center; margin-top:10px; color:var(--light-gray);">
          You must sign in with your DIU email to vote
        </p>
      ` : `
        <div class="notice">
          The election has ended. Please check the results above.
        </div>
      `;
    }
  }

  // Sign out function
  window.signOutUser = async () => {
    try {
      await signOut(auth);
    } catch (error) {
      console.error("Sign out error:", error);
    }
  };

  // Load candidates for public view
  window.loadPublicCandidates = async () => {
    const list = document.getElementById("publicCandidatesList");
    list.innerHTML = "";
    const loading = document.getElementById("loadingPublic");
    loading.style.display = "block";
    
    try {
      const snap = await getDocs(collection(db, "candidates"));
      loading.style.display = "none";
      
      if (snap.empty) {
        list.innerHTML = "<p style='text-align:center;'>No candidates available yet.</p>";
        return;
      }
      
      snap.forEach(docSnap => {
        const c = docSnap.data();
        const canVote = currentUser && currentUser.email.endsWith("@diu.edu.bd") && electionStatus.isActive;
        
        list.innerHTML += `
          <li class="candidate-item">
            <img src="${c.photoURL || 'https://via.placeholder.com/80'}" width="80" height="80">
            <div class="candidate-info">
              <h3>${c.name}</h3>
              <p>${c.bio}</p>
              <div style="display:flex; align-items:center; gap:10px;">
                ${canVote ? `
                  <button class="btn btn-success" onclick="vote('${docSnap.id}', '${currentUser.uid}', '${c.name.replace(/'/g, "\\'")}')">
                    Vote
                  </button>
                ` : `
                  ${electionStatus.isActive ? `
                    <button class="btn btn-primary" onclick="signInUser()" style="display:flex; align-items:center;">
                      <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" class="google-icon">
                      Sign in to Vote
                    </button>
                  ` : `
                    <button class="btn" disabled style="background:var(--gray);">
                      Voting Ended
                    </button>
                  `}
                `}
              </div>
            </div>
          </li>
        `;
      });
    } catch (error) {
      loading.style.display = "none";
      list.innerHTML = `<p style="color:var(--danger); text-align:center;">Error loading candidates. Please try again later.</p>`;
      console.error("Error loading public candidates:", error);
    }
  };

  // Initialize the app when page loads
  window.addEventListener('DOMContentLoaded', () => {
    initApp();
  });

  window.signInAdmin = async () => {
    try {
      const result = await signInWithPopup(auth, provider);
      if (result.user.email === "252-35-007@diu.edu.bd") {
        document.getElementById("adminPanel").style.display = "block";
        loadAdminCandidates();
        loadVotesAdmin();
      } else {
        alert("Access denied: Not an admin");
        await signOut(auth);
      }
    } catch (error) {
      console.error("Admin sign in error:", error);
    }
  };

  window.signInUser = async () => {
    try {
      const result = await signInWithPopup(auth, provider);
      if (!result.user.email.endsWith("@diu.edu.bd")) {
        alert("Only DIU emails are allowed to vote");
        await signOut(auth);
        return;
      }
      loadPublicCandidates();
    } catch (error) {
      console.error("User sign in error:", error);
    }
  };

  window.addCandidate = async () => {
    const name = document.getElementById("candidateName").value;
    const photo = document.getElementById("candidatePhoto").value;
    const bio = document.getElementById("candidateBio").value;
    if (!name || !bio) return alert("Enter a name and bio");
    await addDoc(collection(db, "candidates"), { 
      name, 
      photoURL: photo || 'https://via.placeholder.com/80',
      bio, 
      votes: 0 
    });
    loadAdminCandidates();
    loadPublicCandidates();
  };

  window.loadAdminCandidates = async () => {
    const list = document.getElementById("adminCandidateList");
    list.innerHTML = "<h3>Current Candidates</h3>";
    const loading = document.createElement("div");
    loading.className = "loading-spinner";
    list.appendChild(loading);
    
    try {
      const snap = await getDocs(collection(db, "candidates"));
      list.innerHTML = "<h3>Current Candidates</h3>";
      
      if (snap.empty) {
        list.innerHTML += "<p>No candidates available yet.</p>";
        return;
      }
      
      snap.forEach(docSnap => {
        const c = docSnap.data();
        list.innerHTML += `
          <li class="candidate-item">
            <img src="${c.photoURL || 'https://via.placeholder.com/100'}" width="100" height="100">
            <div class="candidate-info">
              <h3>${c.name}</h3>
              <p>${c.bio}</p>
              <div style="display:flex; gap:10px; align-items:center;">
                <button class="btn btn-danger" onclick="removeCandidate('${docSnap.id}')">Delete</button>
                <span class="vote-count">${c.votes || 0} votes</span>
              </div>
            </div>
          </li>
        `;
      });
    } catch (error) {
      list.innerHTML = "<p>Error loading candidates. Please try again.</p>";
      console.error("Error loading admin candidates:", error);
    }
  };

  window.removeCandidate = async (id) => {
    if (!confirm("Are you sure you want to delete this candidate?")) return;
    await deleteDoc(doc(db, "candidates", id));
    loadAdminCandidates();
    loadPublicCandidates();
  };

  window.loadVotes = async (uid) => {
    document.getElementById("loading").style.display = "block";
    const list = document.getElementById("voteList");
    list.innerHTML = "";
    const votedRef = doc(db, "votes", uid);
    const votedSnap = await getDoc(votedRef);
    
    if (votedSnap.exists()) {
      document.getElementById("loading").style.display = "none";
      list.innerHTML = `
        <div class="notice">
          <p>Thank you for voting! You can view the results when the election concludes.</p>
          <p>Remember: You can only vote once.</p>
        </div>
      `;
      return;
    }
    
    const snap = await getDocs(collection(db, "candidates"));
    document.getElementById("loading").style.display = "none";
    
    if (snap.empty) {
      list.innerHTML = "<p>No candidates available for voting.</p>";
      return;
    }
    
    snap.forEach(docSnap => {
      const c = docSnap.data();
      list.innerHTML += `
        <li class="candidate-item">
          <img src="${c.photoURL || 'https://via.placeholder.com/80'}" width="80" height="80">
          <div class="candidate-info">
            <h3>${c.name}</h3>
            <p>${c.bio}</p>
            <button class="btn btn-success" onclick="vote('${docSnap.id}', '${uid}', '${c.name.replace(/'/g, "\\'")}')">
              Vote for ${c.name}
            </button>
          </div>
        </li>
      `;
    });
  };

  window.vote = async (candidateId, uid, candidateName) => {
    if (!electionStatus.isActive) {
      alert("The election has ended. Voting is no longer allowed.");
      return;
    }
    
    if (!currentUser) {
      alert("Please sign in first");
      return signInUser();
    }
    
    if (!currentUser.email.endsWith("@diu.edu.bd")) {
      alert("Only DIU emails are allowed to vote");
      return;
    }
    
    const confirmVote = confirm(`Are you sure you want to vote for "${candidateName}"?\nThis action cannot be undone.`);
    if (!confirmVote) return;

    document.getElementById("voteList").innerHTML = '<div class="loading-spinner"></div>';
    document.getElementById("publicCandidatesList").innerHTML = '<div class="loading-spinner"></div>';

    try {
      // Verify user again
      const result = await signInWithPopup(auth, provider);
      const userEmail = result.user.email;

      if (!userEmail.endsWith("@diu.edu.bd")) {
        alert("Only DIU emails are allowed to vote");
        return;
      }

      // Check if already voted
      const votedRef = doc(db, "votes", uid);
      const votedSnap = await getDoc(votedRef);
      if (votedSnap.exists()) {
        alert("You have already voted.");
        loadVotes(uid);
        loadPublicCandidates();
        return;
      }

      // Record vote
      await setDoc(votedRef, { 
        candidateId, 
        email: userEmail,
        timestamp: new Date() 
      });
      
      // Update vote count
      const cRef = doc(db, "candidates", candidateId);
      const cSnap = await getDoc(cRef);
      const newVotes = (cSnap.data().votes || 0) + 1;
      await updateDoc(cRef, { votes: newVotes });

      // Update UI
      loadVotes(uid);
      loadPublicCandidates();
      
    } catch (error) {
      console.error("Voting failed", error);
      alert("Something went wrong during voting. Please try again.");
      loadPublicCandidates();
    }
  };

  window.loadVotesAdmin = async () => {
    const list = document.getElementById("voteListAdmin");
    list.innerHTML = "";
    const loading = document.createElement("div");
    loading.className = "loading-spinner";
    list.appendChild(loading);
    
    try {
      const [votesSnap, candidatesSnap] = await Promise.all([
        getDocs(collection(db, "votes")),
        getDocs(collection(db, "candidates"))
      ]);
      
      list.innerHTML = `
        <h4>Total Votes: ${votesSnap.size}</h4>
        <h4>Vote Breakdown:</h4>
      `;
      
      if (candidatesSnap.empty) {
        list.innerHTML += "<p>No candidates available.</p>";
        return;
      }
      
      // Calculate votes per candidate
      const voteCounts = {};
      candidatesSnap.forEach(doc => {
        voteCounts[doc.id] = {
          name: doc.data().name,
          count: doc.data().votes || 0
        };
      });
      
      // Sort by vote count (descending)
      const sortedCandidates = Object.entries(voteCounts).sort((a, b) => b[1].count - a[1].count);
      
      sortedCandidates.forEach(([id, candidate]) => {
        list.innerHTML += `
          <div style="margin:10px 0; padding:10px; background:rgba(255,255,255,0.03); border-radius:8px;">
            <div style="display:flex; justify-content:space-between;">
              <span>${candidate.name}</span>
              <span class="vote-count">${candidate.count} votes</span>
            </div>
            <div style="height:5px; background:var(--gray); margin-top:5px; border-radius:5px;">
              <div style="height:100%; background:var(--primary); width:${candidate.count / Math.max(1, votesSnap.size) * 100}%; border-radius:5px;"></div>
            </div>
          </div>
        `;
      });
      
    } catch (error) {
      list.innerHTML = "<p>Error loading votes. Please try again.</p>";
      console.error("Error loading votes:", error);
    }
  };

  window.publishWinner = async () => {
    if (!confirm("Are you sure you want to publish the winner and end the election?")) return;
    
    try {
      // Get all candidates and their votes
      const candidatesSnap = await getDocs(collection(db, "candidates"));
      if (candidatesSnap.empty) {
        alert("No candidates available");
        return;
      }
      
      // Find the winner
      let winner = null;
      candidatesSnap.forEach(doc => {
        const candidate = doc.data();
        if (!winner || candidate.votes > winner.votes) {
          winner = {
            id: doc.id,
            name: candidate.name,
            photoURL: candidate.photoURL,
            bio: candidate.bio,
            votes: candidate.votes || 0
          };
        }
      });
      
      // Update election status
      await setDoc(doc(db, "election", "status"), {
        isActive: false,
        winner,
        endDate: new Date()
      });
      
      // Refresh UI
      await checkElectionStatus();
      loadPublicCandidates();
      alert(`Winner published: ${winner.name}`);
      
    } catch (error) {
      console.error("Error publishing winner:", error);
      alert("Failed to publish winner. Please try again.");
    }
  };

  window.resetVoting = async () => {
    if (!confirm("WARNING: This will reset ALL votes and reactivate the election. Are you sure?")) return;
    
    try {
      // Reset election status
      await setDoc(doc(db, "election", "status"), {
        isActive: true,
        winner: null,
        startDate: new Date()
      });
      
      // Reset candidate votes
      const candidatesSnap = await getDocs(collection(db, "candidates"));
      const updatePromises = [];
      candidatesSnap.forEach(docSnap => {
        updatePromises.push(updateDoc(doc(db, "candidates", docSnap.id), { votes: 0 }));
      });
      await Promise.all(updatePromises);
      
      // Delete all vote records
      const votesSnap = await getDocs(collection(db, "votes"));
      const deletePromises = [];
      votesSnap.forEach(docSnap => {
        deletePromises.push(deleteDoc(doc(db, "votes", docSnap.id)));
      });
      await Promise.all(deletePromises);
      
      // Refresh UI
      await checkElectionStatus();
      loadAdminCandidates();
      loadPublicCandidates();
      loadVotesAdmin();
      alert("Voting has been reset successfully.");
      
    } catch (error) {
      console.error("Error resetting voting:", error);
      alert("Failed to reset voting. Please try again.");
    }
  };
</script>

</body>
</html>
