<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voting System</title>
  <style>
    #voting-options { display: none; }
    #admin-panel { display: none; }
    #login-section { display: block; }
    #google-signin-btn { margin-top: 20px; }
    #google-admin-btn { margin-top: 20px; position: absolute; top: 20px; right: 20px; }
  </style>

  <!-- Firebase SDK -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-analytics.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCQaeFbaXbeJkw08N3of2Xiu3hMfiW8wTk",
      authDomain: "voting-app-2b276.firebaseapp.com",
      projectId: "voting-app-2b276",
      storageBucket: "voting-app-2b276.firebasestorage.app",
      messagingSenderId: "699531517654",
      appId: "1:699531517654:web:785702f843d21a85c17377",
      measurementId: "G-309D0KG6KL"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);

    // Initialize Firebase Auth and Firestore
    const auth = getAuth(app);
    const db = getFirestore(app);

    const provider = new GoogleAuthProvider();

    // Elements
    const googleSignInBtn = document.getElementById('google-signin-btn');
    const googleAdminBtn = document.getElementById('google-admin-btn');
    const votingOptionsDiv = document.getElementById('voting-options');
    const adminPanelDiv = document.getElementById('admin-panel');
    const candidateListDiv = document.getElementById("candidate-list");

    // Google Sign-In Button for User Login
    googleSignInBtn.addEventListener('click', async () => {
      try {
        const userCredential = await signInWithPopup(auth, provider);
        const user = userCredential.user;

        if (user.email.endsWith('@diu.edu.bd')) {
          displayCandidates();
          votingOptionsDiv.style.display = 'block';
          googleSignInBtn.style.display = 'none';
        } else {
          alert("Only users with @diu.edu.bd emails can vote.");
        }
      } catch (error) {
        console.error("Error during Google sign-in: ", error.message);
      }
    });

    // Google Sign-In Button for Admin
    googleAdminBtn.addEventListener('click', async () => {
      try {
        const userCredential = await signInWithPopup(auth, provider);
        const user = userCredential.user;

        if (user.email === '252-35-007@diu.edu.bd') {
          adminPanelDiv.style.display = 'block';
          googleAdminBtn.style.display = 'none';
        } else {
          alert("Only the admin can access this panel.");
        }
      } catch (error) {
        console.error("Error during Google admin sign-in: ", error.message);
      }
    });

    // Fetch and display candidates
    const displayCandidates = async () => {
      try {
        const snapshot = await getDocs(collection(db, 'candidates'));
        candidateListDiv.innerHTML = '';
        snapshot.forEach(doc => {
          const candidate = doc.data();
          const candidateDiv = document.createElement('div');
          candidateDiv.innerHTML = `
            <img src="${candidate.photoUrl}" alt="${candidate.name}" />
            <p>${candidate.name}</p>
            <button onclick="voteForCandidate('${doc.id}')">Vote for ${candidate.name}</button>
          `;
          candidateListDiv.appendChild(candidateDiv);
        });
      } catch (error) {
        console.error("Error fetching candidates: ", error.message);
      }
    };

    // Vote for a candidate
    window.voteForCandidate = async (candidateId) => {
      const user = auth.currentUser;
      if (user && user.email.endsWith('@diu.edu.bd')) {
        try {
          await addDoc(collection(db, 'votes'), {
            userId: user.uid,
            candidateId: candidateId,
            timestamp: new Date(),
          });
          alert("Vote registered successfully!");
        } catch (error) {
          console.error("Error registering vote: ", error.message);
        }
      } else {
        alert("Only users with @diu.edu.bd email can vote.");
      }
    };

    // Check auth state to show correct interface
    auth.onAuthStateChanged(user => {
      if (user) {
        if (user.email === '252-35-007@diu.edu.bd') {
          googleAdminBtn.style.display = 'block'; // Show Admin Login for Admin
        }
      }
    });
  </script>
</head>
<body>

  <h1>Welcome to the Voting System</h1>

  <!-- Google Sign-In Button for Users -->
  <button id="google-signin-btn">Sign in with Google to Vote</button>

  <!-- Google Sign-In Button for Admin -->
  <button id="google-admin-btn" style="display:none;">Admin Login</button>

  <div id="login-section">
    <h3>Please Sign in to Continue</h3>
  </div>

  <!-- Voting Options (Visible After Login) -->
  <div id="voting-options">
    <h2>Vote for Your Candidate</h2>
    <div id="candidate-list">
      <!-- Candidates will be dynamically loaded here -->
    </div>
  </div>

  <!-- Admin Panel (Visible Only to Admins) -->
  <div id="admin-panel">
    <h2>Admin Panel</h2>
    <button id="add-candidate-btn">Add Candidate</button>
  </div>

</body>
</html>
