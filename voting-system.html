
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Private Voting System</title>
  <style>
    :root {
      --primary: #1e90ff;
      --success: #4CAF50;
      --danger: #f44336;
      --dark: #121212;
      --darker: #0a0a0a;
      --light: #f5f5f5;
      --gray: #333;
      --light-gray: #bbb;
    }
    
    body { 
      background: var(--dark); 
      color: white; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      margin: 8px 5px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-primary {
      background: var(--primary);
    }
    
    .btn-success {
      background: var(--success);
    }
    
    .btn-danger {
      background: var(--danger);
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-outline:hover {
      background: rgba(30, 144, 255, 0.1);
    }
    
    .btn:disabled {
      background: var(--gray);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.7;
    }
    
    .panel {
      margin-top: 30px;
      padding: 25px;
      border-radius: 12px;
      background: var(--darker);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    input, textarea {
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid var(--gray);
      background: rgba(255,255,255,0.05);
      color: white;
      width: 100%;
      max-width: 500px;
      font-size: 16px;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(30, 144, 255, 0.3);
    }
    
    img {
      border-radius: 10px;
      object-fit: cover;
    }
    
    .candidate-item {
      display: flex;
      align-items: center;
      margin: 20px 0;
      padding: 20px;
      background: rgba(255,255,255,0.03);
      border-radius: 10px;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }
    
    .candidate-item:hover {
      background: rgba(255,255,255,0.05);
      border-left-color: var(--primary);
    }
    
    .candidate-item img {
      width: 80px;
      height: 80px;
      margin-right: 20px;
    }
    
    .candidate-info {
      flex: 1;
    }
    
    .candidate-info h3 {
      margin: 0;
      font-size: 1.3em;
      color: white;
    }
    
    .candidate-info p {
      margin: 8px 0;
      color: var(--light-gray);
    }
    
    .vote-count {
      font-weight: bold;
      color: var(--primary);
    }
    
    h1, h2, h3 {
      color: white;
    }
    
    h1 {
      text-align: center;
      color: #00ff00;
      text-shadow: 0 0 10px rgba(0, 255, 0, 0.3), 0 0 20px rgba(0, 255, 0, 0.2);
      font-size: 2.5em;
      margin-bottom: 30px;
    }
    
    h2 {
      margin-top: 0;
      font-size: 1.8em;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 10px;
    }
    
    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top: 4px solid var(--success);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 30px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .auth-status {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    
    .google-icon {
      width: 20px;
      height: 20px;
      margin-right: 8px;
    }
    
    .action-buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    
    .notice {
      background: rgba(76, 175, 80, 0.1);
      border-left: 4px solid var(--success);
      padding: 15px;
      border-radius: 0 8px 8px 0;
      margin: 20px 0;
    }
    
    .notice a {
      color: var(--success);
      text-decoration: none;
      font-weight: bold;
    }
    
    .notice a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
<div class="container">

<!-- Popup Guide -->
<div id="popup" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000000dd;z-index:9999;display:flex;justify-content:center;align-items:center;flex-direction:column;text-align:center;padding:20px;">
  <h2 style="color:lightgreen;">üó≥Ô∏è Voting System ‚Äì Quick User Guide</h2>
  <p><strong>üîê Login</strong><br>Click "Sign in with DIU Mail to Vote".<br>Use your DIU email only.</p>
  <p><strong>‚úÖ Vote</strong><br>Choose a candidate.<br>Click "Vote" ‚Üí Confirm.<br>Sign in again to verify ‚Üí Done!<br>Message: "Thank you for voting..."</p>
  <p><strong>‚ö†Ô∏è‚ö†Ô∏è You can vote only once.</strong></p>
  <p class="loading-message">‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è The server is a bit slow‚Äîplease wait a moment after clicking any button.</p>
  <p><strong>üì¢ Results</strong><br>Visit the Notice Board:<br><a href="https://mizan658.github.io/AL/notice.html" style="color:lightblue;">https://mizan658.github.io/AL/notice.html</a></p>
  <button onclick="document.getElementById('popup').style.display='none'" style="margin-top:20px;background:#4caf50;border:none;padding:12px 24px;border-radius:8px;color:white;cursor:pointer;font-weight:bold;">I Understand</button>
  <div class="contact-mail" style="margin-top:20px;">Contact Mail: <a href="mailto:help.to.tz@gmail.com" style="color:#00ffff">help.to.tz@gmail.com</a></div>
</div>

<h1>Welcome to Private Voting System</h1>

<div class="action-buttons">
  <div>
    <button class="btn btn-primary" onclick="signInUser()">
      <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" class="google-icon">
      Sign in with DIU Mail to Vote
    </button>
    <button onclick="window.location.href='https://mizan658.github.io/AL/notice.html'" class="btn btn-outline">Notice</button>
    <button onclick="window.location.href='https://mizan658.github.io/AL/index.html'" class="btn btn-outline">Home</button>
  </div>
  <button class="btn btn-danger" onclick="signInAdmin()">Admin Panel Login</button>
</div>

<div id="adminPanel" class="panel" style="display:none;">
  <h2>Admin Panel</h2>
  <input type="text" id="candidateName" placeholder="Candidate Name">
  <input type="text" id="candidatePhoto" placeholder="Photo URL">
  <textarea id="candidateBio" placeholder="Candidate Bio" rows="4"></textarea>
  <button class="btn btn-success" onclick="addCandidate()">Add Candidate</button>

  <h3>Manage Candidates</h3>
  <ul id="candidateList"></ul>

  <h3>Manage Votes</h3>
  <button class="btn btn-primary" onclick="loadVotesAdmin()">Load Votes</button>
  <ul id="voteListAdmin"></ul>
  <button class="btn btn-danger" onclick="resetVotes()">Reset Votes</button>
</div>

<div id="voteSection" class="panel" style="display:none;">
  <div id="authStatus" class="auth-status"></div>
  <h2>Vote for Your Candidate</h2>
  <div id="loading" class="loading-spinner" style="display:none;"></div>
  <ul id="voteList"></ul>
</div>

<div id="candidatesListPublic" class="panel">
  <h2>Candidates</h2>
  <div id="publicAuthStatus"></div>
  <div id="loadingPublic" class="loading-spinner"></div>
  <ul id="publicCandidatesList"></ul>
</div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCQaeFbaXbeJkw08N3of2Xiu3hMfiW8wTk",
    authDomain: "voting-app-2b276.firebaseapp.com",
    projectId: "voting-app-2b276",
    storageBucket: "voting-app-2b276.appspot.com",
    messagingSenderId: "699531517654",
    appId: "1:699531517654:web:785702f843d21a85c17377",
    measurementId: "G-309D0KG6KL"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // Track current user
  let currentUser = null;

  // Auth state listener
  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    updateAuthUI();
    
    if (user && user.email.endsWith("@diu.edu.bd")) {
      document.getElementById("voteSection").style.display = "block";
      loadVotes(user.uid);
    } else {
      document.getElementById("voteSection").style.display = "none";
    }
  });

  // Update authentication UI
  function updateAuthUI() {
    const authStatus = document.getElementById("authStatus");
    const publicAuthStatus = document.getElementById("publicAuthStatus");
    
    if (currentUser) {
      authStatus.innerHTML = `
        <img src="${currentUser.photoURL || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" class="user-avatar">
        <span>Signed in as ${currentUser.email}</span>
        <button class="btn btn-danger" onclick="signOutUser()" style="margin-left:auto;">Sign Out</button>
      `;
      
      if (currentUser.email.endsWith("@diu.edu.bd")) {
        publicAuthStatus.innerHTML = `
          <div class="notice">
            You are signed in. You can now vote for your preferred candidate.
          </div>
        `;
      } else {
        publicAuthStatus.innerHTML = `
          <div style="color:var(--danger); padding:10px; background:rgba(244,67,54,0.1); border-radius:8px;">
            Only DIU emails are allowed to vote. You are signed in with ${currentUser.email}
          </div>
        `;
      }
    } else {
      authStatus.innerHTML = `
        <button class="btn btn-primary" onclick="signInUser()">
          <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" class="google-icon">
          Sign in with DIU Mail to Vote
        </button>
      `;
      
      publicAuthStatus.innerHTML = `
        <button class="btn btn-primary" onclick="signInUser()" style="width:100%;">
          <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" class="google-icon">
          Sign in with DIU Mail to Vote
        </button>
        <p style="text-align:center; margin-top:10px; color:var(--light-gray);">
          You must sign in with your DIU email to vote
        </p>
      `;
    }
  }

  // Sign out function
  window.signOutUser = async () => {
    try {
      await signOut(auth);
    } catch (error) {
      console.error("Sign out error:", error);
    }
  };

  // Load candidates for public view
  window.loadPublicCandidates = async () => {
    const list = document.getElementById("publicCandidatesList");
    list.innerHTML = "";
    const loading = document.getElementById("loadingPublic");
    loading.style.display = "block";
    
    try {
      const snap = await getDocs(collection(db, "candidates"));
      loading.style.display = "none";
      
      if (snap.empty) {
        list.innerHTML = "<p style='text-align:center;'>No candidates available yet.</p>";
        return;
      }
      
      snap.forEach(docSnap => {
        const c = docSnap.data();
        const canVote = currentUser && currentUser.email.endsWith("@diu.edu.bd");
        
        list.innerHTML += `
          <li class="candidate-item">
            <img src="${c.photoURL || 'https://via.placeholder.com/80'}" width="80" height="80">
            <div class="candidate-info">
              <h3>${c.name}</h3>
              <p>${c.bio}</p>
              <div style="display:flex; align-items:center; gap:10px;">
                ${canVote ? `
                  <button class="btn btn-success" onclick="vote('${docSnap.id}', '${currentUser.uid}', '${c.name.replace(/'/g, "\\'")}')">
                    Vote
                  </button>
                ` : `
                  <button class="btn btn-primary" onclick="signInUser()" style="display:flex; align-items:center;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" class="google-icon">
                    Sign in to Vote
                  </button>
                `}
                <span class="vote-count">${c.votes || 0} votes</span>
              </div>
            </div>
          </li>
        `;
      });
    } catch (error) {
      loading.style.display = "none";
      list.innerHTML = `<p style="color:var(--danger); text-align:center;">Error loading candidates. Please try again later.</p>`;
      console.error("Error loading public candidates:", error);
    }
  };

  // Call the function when page loads
  window.addEventListener('DOMContentLoaded', () => {
    loadPublicCandidates();
  });

  window.signInAdmin = async () => {
    try {
      const result = await signInWithPopup(auth, provider);
      if (result.user.email === "252-35-007@diu.edu.bd") {
        document.getElementById("adminPanel").style.display = "block";
        loadCandidates();
        loadVotesAdmin();
      } else {
        alert("Access denied: Not an admin");
        await signOut(auth);
      }
    } catch (error) {
      console.error("Admin sign in error:", error);
    }
  };

  window.signInUser = async () => {
    try {
      const result = await signInWithPopup(auth, provider);
      if (!result.user.email.endsWith("@diu.edu.bd")) {
        alert("Only DIU emails are allowed to vote");
        await signOut(auth);
        return;
      }
      loadPublicCandidates(); // Refresh to show vote buttons
    } catch (error) {
      console.error("User sign in error:", error);
    }
  };

  window.addCandidate = async () => {
    const name = document.getElementById("candidateName").value;
    const photo = document.getElementById("candidatePhoto").value;
    const bio = document.getElementById("candidateBio").value;
    if (!name || !bio) return alert("Enter a name and bio");
    await addDoc(collection(db, "candidates"), { 
      name, 
      photoURL: photo || 'https://via.placeholder.com/80',
      bio, 
      votes: 0 
    });
    loadCandidates();
    loadPublicCandidates();
  };

  window.loadCandidates = async () => {
    const list = document.getElementById("candidateList");
    list.innerHTML = "";
    const snap = await getDocs(collection(db, "candidates"));
    snap.forEach(docSnap => {
      const c = docSnap.data();
      list.innerHTML += `
        <li class="candidate-item">
          <img src="${c.photoURL || 'https://via.placeholder.com/100'}" width="100" height="100">
          <div class="candidate-info">
            <h3>${c.name}</h3>
            <p>${c.bio}</p>
            <div style="display:flex; gap:10px; align-items:center;">
              <button class="btn btn-danger" onclick="removeCandidate('${docSnap.id}')">Delete</button>
              <span class="vote-count">${c.votes || 0} votes</span>
            </div>
          </div>
        </li>
      `;
    });
  };

  window.removeCandidate = async (id) => {
    if (!confirm("Are you sure you want to delete this candidate?")) return;
    await deleteDoc(doc(db, "candidates", id));
    loadCandidates();
    loadPublicCandidates();
  };

  window.loadVotes = async (uid) => {
    document.getElementById("loading").style.display = "block";
    const list = document.getElementById("voteList");
    list.innerHTML = "";
    const votedRef = doc(db, "votes", uid);
    const votedSnap = await getDoc(votedRef);
    
    if (votedSnap.exists()) {
      document.getElementById("loading").style.display = "none";
      list.innerHTML = `
        <div class="notice">
          <p>Thank you for voting! You can view the results on the <a href="https://mizan658.github.io/AL/notice.html">notice board</a>.</p>
          <p>Remember: You can only vote once.</p>
        </div>
      `;
      return;
    }
    
    const snap = await getDocs(collection(db, "candidates"));
    document.getElementById("loading").style.display = "none";
    
    if (snap.empty) {
      list.innerHTML = "<p>No candidates available for voting.</p>";
      return;
    }
    
    snap.forEach(docSnap => {
      const c = docSnap.data();
      list.innerHTML += `
        <li class="candidate-item">
          <img src="${c.photoURL || 'https://via.placeholder.com/80'}" width="80" height="80">
          <div class="candidate-info">
            <h3>${c.name}</h3>
            <p>${c.bio}</p>
            <button class="btn btn-success" onclick="vote('${docSnap.id}', '${uid}', '${c.name.replace(/'/g, "\\'")}')">
              Vote for ${c.name}
            </button>
            <span class="vote-count">${c.votes || 0} votes</span>
          </div>
        </li>
      `;
    });
  };

  window.vote = async (candidateId, uid, candidateName) => {
    if (!currentUser) {
      alert("Please sign in first");
      return signInUser();
    }
    
    if (!currentUser.email.endsWith("@diu.edu.bd")) {
      alert("Only DIU emails are allowed to vote");
      return;
    }
    
    const confirmVote = confirm(`Are you sure you want to vote for "${candidateName}"?\nThis action cannot be undone.`);
    if (!confirmVote) return;

    document.getElementById("voteList").innerHTML = '<div class="loading-spinner"></div>';
    document.getElementById("publicCandidatesList").innerHTML = '<div class="loading-spinner"></div>';

    try {
      // Verify user again
      const result = await signInWithPopup(auth, provider);
      const userEmail = result.user.email;

      if (!userEmail.endsWith("@diu.edu.bd")) {
        alert("Only DIU emails are allowed to vote");
        return;
      }

      // Check if already voted
      const votedRef = doc(db, "votes", uid);
      const votedSnap = await getDoc(votedRef);
      if (votedSnap.exists()) {
        alert("You have already voted.");
        loadVotes(uid);
        loadPublicCandidates();
        return;
      }

      // Record vote
      await setDoc(votedRef, { 
        candidateId, 
        email: userEmail,
        timestamp: new Date() 
      });
      
      // Update vote count
      const cRef = doc(db, "candidates", candidateId);
      const cSnap = await getDoc(cRef);
      const newVotes = (cSnap.data().votes || 0) + 1;
      await updateDoc(cRef, { votes: newVotes });

      // Update UI
      loadVotes(uid);
      loadPublicCandidates();
      
    } catch (error) {
      console.error("Voting failed", error);
      alert("Something went wrong during voting. Please try again.");
      loadPublicCandidates();
    }
  };

  window.loadVotesAdmin = async () => {
    const list = document.getElementById("voteListAdmin");
    list.innerHTML = "";
    const loading = document.createElement("div");
    loading.className = "loading-spinner";
    list.appendChild(loading);
    
    try {
      const snap = await getDocs(collection(db, "votes"));
      list.innerHTML = "";
      
      if (snap.empty) {
        list.innerHTML = "<p>No votes recorded yet.</p>";
        return;
      }
      
      snap.forEach(docSnap => {
        const v = docSnap.data();
        const time = v.timestamp ? v.timestamp.toDate().toLocaleString() : "Unknown time";
        list.innerHTML += `
          <li style="padding:15px; margin:10px 0; background:rgba(255,255,255,0.03); border-radius:8px;">
            <div><strong>Email:</strong> ${v.email}</div>
            <div><strong>Candidate ID:</strong> ${v.candidateId}</div>
            <div><strong>Time:</strong> ${time}</div>
          </li>
        `;
      });
    } catch (error) {
      list.innerHTML = "<p>Error loading votes. Please try again.</p>";
      console.error("Error loading votes:", error);
    }
  };

  window.resetVotes = async () => {
    if (!confirm("WARNING: This will reset ALL votes. Are you sure?")) return;
    
    const loading = document.createElement("div");
    loading.className = "loading-spinner";
    document.getElementById("voteListAdmin").innerHTML = "";
    document.getElementById("voteListAdmin").appendChild(loading);
    
    try {
      // Reset candidate votes
      const candidatesSnap = await getDocs(collection(db, "candidates"));
      const updatePromises = [];
      candidatesSnap.forEach(docSnap => {
        updatePromises.push(updateDoc(doc(db, "candidates", docSnap.id), { votes: 0 }));
      });
      await Promise.all(updatePromises);
      
      // Delete all vote records
      const votesSnap = await getDocs(collection(db, "votes"));
      const deletePromises = [];
      votesSnap.forEach(docSnap => {
        deletePromises.push(deleteDoc(doc(db, "votes", docSnap.id)));
      });
      await Promise.all(deletePromises);
      
      alert("All votes have been reset successfully.");
      loadCandidates();
      loadPublicCandidates();
      loadVotesAdmin();
    } catch (error) {
      alert("Error resetting votes. Please try again.");
      console.error("Error resetting votes:", error);
    }
  };
</script>

</body>
</html>
