<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Previous head content remains the same until the style section -->
  <style>
    /* Add these new styles at the end of your existing styles */
    
    /* Name Change Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .modal-overlay.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background-color: white;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      transform: translateY(-20px);
      transition: transform 0.3s ease;
    }
    
    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }
    
    .modal-content h3 {
      margin-bottom: 15px;
      color: #333;
    }
    
    .modal-content input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .modal-buttons button {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    
    .modal-buttons button:first-child {
      background-color: #f0f0f0;
      color: #333;
    }
    
    .modal-buttons button:last-child {
      background-color: #0084ff;
      color: white;
    }
    
    #changeNameBtn {
      margin-left: 10px;
      padding: 8px 16px;
      border-radius: 20px;
      border: none;
      background-color: #f0f7ff;
      color: #0084ff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    #changeNameBtn:hover {
      background-color: #d6e8ff;
    }
  </style>
</head>
<body>
  <!-- Previous body content remains the same until the script section -->

  <!-- Add this modal HTML right before the closing </body> tag -->
  <div class="modal-overlay" id="nameModal">
    <div class="modal-content">
      <h3>Change Your Display Name</h3>
      <p>You can set your display name only once. Choose wisely!</p>
      <input type="text" id="nameInput" placeholder="Enter your display name" maxlength="20" />
      <div class="modal-buttons">
        <button id="cancelNameBtn">Cancel</button>
        <button id="saveNameBtn">Save</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    // ... (keep your existing Firebase config and initialization code)

    // Add these new variables
    const nameModal = document.getElementById('nameModal');
    const nameInput = document.getElementById('nameInput');
    const saveNameBtn = document.getElementById('saveNameBtn');
    const cancelNameBtn = document.getElementById('cancelNameBtn');
    const changeNameBtn = document.createElement('button');
    changeNameBtn.id = 'changeNameBtn';
    changeNameBtn.textContent = 'Change Name';
    changeNameBtn.style.display = 'none';

    // Add the change name button to the header
    document.querySelector('header div').appendChild(changeNameBtn);

    // Add these new event listeners
    changeNameBtn.addEventListener('click', () => {
      nameModal.classList.add('active');
    });

    cancelNameBtn.addEventListener('click', () => {
      nameModal.classList.remove('active');
    });

    saveNameBtn.addEventListener('click', async () => {
      const newName = nameInput.value.trim();
      if (!newName) {
        alert('Please enter a valid name');
        return;
      }
      
      if (newName.length > 20) {
        alert('Name must be 20 characters or less');
        return;
      }
      
      try {
        // Store the display name in Firestore
        const userRef = doc(db, 'users', currentUser.email);
        await setDoc(userRef, {
          displayName: newName,
          email: currentUser.email,
          timestamp: serverTimestamp()
        }, { merge: true });
        
        nameModal.classList.remove('active');
        changeNameBtn.style.display = 'none'; // Hide the button after name is set
        alert('Display name set successfully!');
      } catch (error) {
        console.error('Error saving display name:', error);
        alert('Error saving display name');
      }
    });

    // Modify the onAuthStateChanged callback to check for display name
    onAuthStateChanged(auth, async (user) => {
      if (!user || !user.email.endsWith("@diu.edu.bd")) {
        alert("Only @diu.edu.bd emails are allowed.");
        signOut(auth);
        return;
      }

      const adminEmail = "252-35-007@diu.edu.bd";
      currentUser = user;

      // Check if user has a display name set
      const userRef = doc(db, 'users', user.email);
      const userSnap = await getDoc(userRef);
      
      // Show change name button only if display name isn't set yet
      if (!userSnap.exists() || !userSnap.data().displayName) {
        changeNameBtn.style.display = 'block';
      } else {
        changeNameBtn.style.display = 'none';
      }

      // ... (rest of your existing auth state changed code)
    });

    // Modify the message display code to use display names
    onSnapshot(q, async (snapshot) => {
      messagesDiv.innerHTML = "";
      for (const docSnap of snapshot.docs) {
        const msg = docSnap.data();
        
        // Get the display name for the sender
        let displayName = msg.sender.split('@')[0];
        const userRef = doc(db, 'users', msg.sender);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists() && userSnap.data().displayName) {
          displayName = userSnap.data().displayName;
        }
        
        const msgEl = document.createElement("div");
        msgEl.className = msg.sender === currentUser.email ? "message own-message" : "message other-message";
        
        const time = msg.timestamp?.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) || "sending...";
        msgEl.innerHTML = `
          <div class="sender-name">${displayName}</div>
          <div>${msg.text}</div>
          <div class="message-info">${time}</div>
        `;
        messagesDiv.appendChild(msgEl);
      }
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // ... (rest of your existing code)
  </script>
</body>
</html>
