<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/babel-standalone@7.22.10/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js"></script>
  <style>
    .glow { 
      animation: glow 1.5s ease-in-out infinite alternate; 
      text-shadow: 0 0 5px #fff, 0 0 10px #ff0; 
    }
    @keyframes glow {
      from { text-shadow: 0 0 5px #fff, 0 0 10px #ff0; }
      to { text-shadow: 0 0 10px #fff, 0 0 20px #ff0; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    // Use the global firebase object
    const { initializeApp } = firebase;
    const { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } = firebase.auth;
    const { getDatabase, ref, set, get, onValue, push, update, off } = firebase.database;
    const { getStorage, ref as storageRef, uploadBytes, getDownloadURL } = firebase.storage;

    const firebaseConfig = {
      apiKey: "AIzaSyAEYjUeSuFxpyZuphg0vB2AK24eyHSjBak",
      authDomain: "chat-7c4ed.firebaseapp.com",
      databaseURL: "https://chat-7c4ed-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "chat-7c4ed",
      storageBucket: "chat-7c4ed.firebasestorage.app",
      messagingSenderId: "871465831321",
      appId: "1:871465831321:web:f9ac2aeef73133450b2108",
      measurementId: "G-SSMJNPHZXD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    const randomNames = ['StarGazer', 'MoonWalker', 'SkyDiver', 'CloudChaser', 'DreamCatcher'];
    const inappropriateWords = ['badword1', 'badword2']; // Expand as needed

    function App() {
      const [user, setUser] = React.useState(null);
      const [name, setName] = React.useState('');
      const [isNameSet, setIsNameSet] = React.useState(false);
      const [onlineUsers, setOnlineUsers] = React.useState([]);
      const [typingUsers, setTypingUsers] = React.useState([]);
      const [messages, setMessages] = React.useState([]);
      const [isPro, setIsPro] = React.useState(false);
      const [isAdmin, setIsAdmin] = React.useState(false);
      const [suspension, setSuspension] = React.useState(null);
      const [messageInput, setMessageInput] = React.useState('');
      const [file, setFile] = React.useState(null);
      const [usersList, setUsersList] = React.useState([]);
      const [selectedUserId, setSelectedUserId] = React.useState('');

      React.useEffect(() => {
        const handleAuthChange = async (currentUser) => {
          if (currentUser) {
            if (!currentUser.email.endsWith('@diu.edu.bd')) {
              alert('Only @diu.edu.bd emails are allowed.');
              await auth.signOut();
              return;
            }
            setUser(currentUser);
            const userRef = ref(db, `users/${currentUser.uid}`);
            const snapshot = await get(userRef).catch(() => null);
            if (!snapshot || !snapshot.exists()) {
              const randomName = randomNames[Math.floor(Math.random() * randomNames.length)];
              await set(userRef, {
                email: currentUser.email,
                name: randomName,
                isPro: false,
                nameChanged: false,
                blocked: false,
                suspensionEnd: null,
                isAdmin: currentUser.email === '252-35-007@diu.edu.bd',
                online: true,
                typing: false
              });
              setName(randomName);
            } else {
              const data = snapshot.val();
              setName(data.name);
              setIsNameSet(data.nameChanged);
              setIsPro(data.isPro);
              setIsAdmin(data.isAdmin);
              setSuspension(data.suspensionEnd);
            }
            await update(ref(db, `users/${currentUser.uid}`), { online: true });
            const handleBeforeUnload = () => update(ref(db, `users/${currentUser.uid}`), { online: false, typing: false });
            window.addEventListener('beforeunload', handleBeforeUnload);
            return () => window.removeEventListener('beforeunload', handleBeforeUnload);
          } else {
            setUser(null);
          }
        };

        onAuthStateChanged(auth, handleAuthChange);

        const usersRef = ref(db, 'users');
        const usersListener = onValue(usersRef, (snapshot) => {
          const users = [];
          const typing = [];
          const allUsers = [];
          snapshot.forEach((child) => {
            const data = child.val();
            if (data.online) users.push(data.name);
            if (data.typing) typing.push(data.name);
            allUsers.push({ id: child.key, ...data });
          });
          setOnlineUsers(users);
          setTypingUsers(typing);
          setUsersList(allUsers);
        });

        const messagesRef = ref(db, 'messages');
        const messagesListener = onValue(messagesRef, (snapshot) => {
          const msgs = [];
          snapshot.forEach((child) => {
            msgs.push({ id: child.key, ...child.val() });
          });
          setMessages(msgs);
        });

        return () => {
          off(usersRef, 'value', usersListener);
          off(messagesRef, 'value', messagesListener);
        };
      }, []);

      const signInWithGoogle = async () => {
        const provider = new GoogleAuthProvider();
        try {
          await signInWithPopup(auth, provider);
        } catch (error) {
          console.error('Sign-in error:', error);
          alert('Failed to sign in. Please try again.');
        }
      };

      const handleNameChange = async () => {
        if (isNameSet) {
          alert('You can only change your name once.');
          return;
        }
        if (!name.trim()) {
          alert('Name cannot be empty.');
          return;
        }
        if (inappropriateWords.some(word => name.toLowerCase().includes(word))) {
          alert('Name contains inappropriate words.');
          return;
        }
        try {
          await update(ref(db, `users/${user.uid}`), { name, nameChanged: true });
          setIsNameSet(true);
        } catch (error) {
          console.error('Name change error:', error);
          alert('Failed to change name.');
        }
      };

      const sendMessage = async () => {
        // Rate limiting check
        const rateLimitRef = ref(db, `rateLimits/${user.uid}`);
        const snapshot = await get(rateLimitRef);
        
        if (snapshot.exists() && snapshot.val() > Date.now() - 60000) {
          alert('Please wait a minute before sending another message');
          return;
        }

        if (suspension && suspension > Date.now()) {
          alert(`You are suspended until ${new Date(suspension).toLocaleString()}`);
          return;
        }
        if (!messageInput.trim() && !file) return;
        try {
          let fileUrl = null;
          let fileType = null;
          if (file) {
            if (!isPro && file.type.startsWith('video')) {
              alert('Video uploads are only available in Chat Pro.');
              return;
            }
            const fileRef = storageRef(storage, `uploads/${Date.now()}_${file.name}`);
            await uploadBytes(fileRef, file);
            fileUrl = await getDownloadURL(fileRef);
            fileType = file.type;
          }
          await push(ref(db, 'messages'), {
            userId: user.uid,
            name,
            text: messageInput,
            fileUrl,
            fileType,
            timestamp: Date.now(),
            isPro,
            reactions: {}
          });

          // Update rate limit after successful message send
          await set(rateLimitRef, Date.now());

          setMessageInput('');
          setFile(null);
          await update(ref(db, `users/${user.uid}`), { typing: false });
        } catch (error) {
          console.error('Send message error:', error);
          alert('Failed to send message.');
        }
      };

      const reactToMessage = async (messageId, reaction) => {
        try {
          await update(ref(db, `messages/${messageId}/reactions`), {
            [user.uid]: reaction
          });
        } catch (error) {
          console.error('Reaction error:', error);
        }
      };

      const createPoll = async () => {
        if (!isPro) return;
        const question = prompt('Enter poll question:');
        if (!question) return;
        const options = prompt('Enter options (comma-separated):').split(',').map(o => o.trim()).filter(o => o);
        if (options.length < 2) {
          alert('Poll must have at least two options.');
          return;
        }
        try {
          await push(ref(db, 'polls'), {
            userId: user.uid,
            name,
            question,
            options: options.reduce((acc, opt) => ({ ...acc, [opt]: 0 }), {}),
            timestamp: Date.now()
          });
        } catch (error) {
          console.error('Poll creation error:', error);
          alert('Failed to create poll.');
        }
      };

      const voteInPoll = async (pollId, option) => {
        try {
          await update(ref(db, `polls/${pollId}/options`), {
            [option]: firebase.database.ServerValue.increment(1)
          });
        } catch (error) {
          console.error('Poll vote error:', error);
        }
      };

      const reportUser = async (reportedUserId) => {
        if (!isPro) return;
        try {
          const reportRef = ref(db, `reports/${reportedUserId}`);
          const snapshot = await get(reportRef);
          const reports = snapshot.val() ? snapshot.val().count + 1 : 1;
          await set(reportRef, { count: reports });
          if (reports >= 5) {
            await update(ref(db, `users/${reportedUserId}`), {
              suspensionEnd: Date.now() + 10 * 60 * 1000 // 10 minutes
            });
          }
        } catch (error) {
          console.error('Report error:', error);
          alert('Failed to report user.');
        }
      };

      const adminAction = async (action, duration = null) => {
        if (!isAdmin || !selectedUserId) {
          alert('Please select a user.');
          return;
        }
        try {
          if (action === 'block') {
            await update(ref(db, `users/${selectedUserId}`), { blocked: true });
          } else if (action === 'unblock') {
            await update(ref(db, `users/${selectedUserId}`), { blocked: false });
          } else if (action === 'suspend') {
            await update(ref(db, `users/${selectedUserId}`), { suspensionEnd: Date.now() + duration });
          } else if (action === 'makePro') {
            await update(ref(db, `users/${selectedUserId}`), { isPro: true });
          }
          setSelectedUserId('');
        } catch (error) {
          console.error('Admin action error:', error);
          alert('Failed to perform admin action.');
        }
      };

      if (!user) {
        return (
          <div className="flex items-center justify-center h-screen bg-gray-100">
            <button
              onClick={signInWithGoogle}
              className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
            >
              Sign in with Google
            </button>
          </div>
        );
      }

      if (!isNameSet && !suspension) {
        return (
          <div className="flex flex-col items-center justify-center h-screen bg-gray-100">
            <p className="mb-4 text-lg">Welcome! Your temporary name is <span className="font-bold">{name}</span>.</p>
            <p className="mb-4">Please choose a new name (avoid using your real name):</p>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="mb-4 p-2 border rounded"
            />
            <button
              onClick={handleNameChange}
              className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
            >
              Set Name
            </button>
          </div>
        );
      }

      if (suspension && suspension > Date.now()) {
        return (
          <div className="flex items-center justify-center h-screen bg-gray-100">
            <p>You are suspended until {new Date(suspension).toLocaleString()}</p>
          </div>
        );
      }

      return (
        <div className="flex h-screen bg-gray-100">
          <div className="flex-1 flex flex-col">
            <div className="p-4 bg-blue-500 text-white">
              <h1 className="text-xl">{isPro ? 'Chat Pro' : 'Chat Group'}</h1>
              <p>Online: {onlineUsers.length} | Typing: {typingUsers.join(', ')}</p>
            </div>
            <div className="flex-1 overflow-y-auto p-4">
              {messages.map((msg) => (
                <div key={msg.id} className="mb-4">
                  <p className={msg.isPro ? 'glow font-bold' : 'text-black'}>
                    {msg.name}: {msg.text}
                  </p>
                  {msg.fileUrl && (
                    msg.fileType.startsWith('image') ? (
                      <img src={msg.fileUrl} alt="Uploaded" className="max-w-xs" />
                    ) : isPro ? (
                      <video src={msg.fileUrl} controls className="max-w-xs" />
                    ) : null
                  )}
                  <div className="flex gap-1">
                    {isPro ? (
                      ['👍', '👎', '❤', '😂', '😡', '🥳', '😭', '😤', '🫡'].map((r) => (
                        <button key={r} onClick={() => reactToMessage(msg.id, r)} className="text-sm">{r}</button>
                      ))
                    ) : (
                      ['👍', '👎'].map((r) => (
                        <button key={r} onClick={() => reactToMessage(msg.id, r)} className="text-sm">{r}</button>
                      ))
                    )}
                    {isPro && <button onClick={() => reportUser(msg.userId)} className="text-sm text-red-500">Report</button>}
                  </div>
                  {msg.reactions && (
                    <div className="text-sm">
                      {Object.values(msg.reactions).map((r, i) => <span key={i}>{r}</span>)}
                    </div>
                  )}
                </div>
              ))}
            </div>
            <div className="p-4 flex gap-2">
              <input
                type="text"
                value={messageInput}
                onChange={(e) => {
                  setMessageInput(e.target.value);
                  update(ref(db, `users/${user.uid}`), { typing: e.target.value !== '' });
                }}
                placeholder="Type a message..."
                className="flex-1 p-2 border rounded"
              />
              <input
                type="file"
                accept={isPro ? 'image/*,video/*' : 'image/*'}
                onChange={(e) => setFile(e.target.files[0])}
                className="p-2"
              />
              <button
                onClick={sendMessage}
                className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
              >
                Send
              </button>
              {isPro && (
                <button
                  onClick={createPoll}
                  className="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600"
                >
                  Create Poll
                </button>
              )}
            </div>
          </div>
          {isAdmin && (
            <div className="w-64 bg-gray-200 p-4">
              <h2 className="text-lg font-bold mb-4">Admin Panel</h2>
              <select
                value={selectedUserId}
                onChange={(e) => setSelectedUserId(e.target.value)}
                className="mb-4 p-2 w-full border rounded"
              >
                <option value="">Select a user</option>
                {usersList.map((u) => (
                  <option key={u.id} value={u.id}>{u.name} ({u.email})</option>
                ))}
              </select>
              <button
                onClick={() => adminAction('block')}
                className="mb-2 w-full bg-red-500 text-white p-2 rounded hover:bg-red-600"
              >
                Block User
              </button>
              <button
                onClick={() => adminAction('unblock')}
                className="mb-2 w-full bg-green-500 text-white p-2 rounded hover:bg-green-600"
              >
                Unblock User
              </button>
              <button
                onClick={() => adminAction('suspend', 60 * 1000)}
                className="mb-2 w-full bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600"
              >
                Suspend (1m)
              </button>
              <button
                onClick={() => adminAction('suspend', 3600 * 1000)}
                className="mb-2 w-full bg-yellow-600 text-white p-2 rounded hover:bg-yellow-700"
              >
                Suspend (1h)
              </button>
              <button
                onClick={() => adminAction('suspend', 24 * 3600 * 1000)}
                className="mb-2 w-full bg-yellow-700 text-white p-2 rounded hover:bg-yellow-800"
              >
                Suspend (1d)
              </button>
              <button
                onClick={() => adminAction('makePro')}
                className="mb-2 w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
              >
                Make Pro
              </button>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
