<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DIU Chat App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

  <div id="chatApp" class="w-full max-w-lg bg-gray-800 rounded-lg p-4 hidden">
    <div class="flex justify-between items-center mb-2">
      <div id="userName" class="text-green-400 font-semibold">Welcome</div>
      <button id="logout" class="text-sm text-red-400 hover:underline">Logout</button>
    </div>
    <div id="messages" class="h-80 overflow-y-scroll mb-2 space-y-2"></div>
    <div class="text-sm text-gray-400 mb-2" id="typingStatus"></div>
    <form id="chatForm" class="flex gap-2">
      <input id="messageInput" class="flex-1 p-2 rounded bg-gray-700 text-white" placeholder="Type a message..." />
      <button class="bg-green-600 px-4 rounded">Send</button>
    </form>
  </div>

  <button id="signInBtn" class="bg-green-600 px-6 py-3 rounded hidden">Sign in with DIU Google</button>

  <!-- Firebase Config -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCiEVpLPaJ5AtFAaV7boxne-d-tVR1d3K0",
      authDomain: "chat-88f0f.firebaseapp.com",
      projectId: "chat-88f0f",
      storageBucket: "chat-88f0f.appspot.com",
      messagingSenderId: "146118641258",
      appId: "1:146118641258:web:f311645f40c8fbcadbac13",
      measurementId: "G-H7LPCPMMYM"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();
  </script>

  <!-- App Logic -->
  <script>
    const signInBtn = document.getElementById("signInBtn");
    const chatApp = document.getElementById("chatApp");
    const userName = document.getElementById("userName");
    const logoutBtn = document.getElementById("logout");
    const messageInput = document.getElementById("messageInput");
    const chatForm = document.getElementById("chatForm");
    const messagesDiv = document.getElementById("messages");
    const typingStatus = document.getElementById("typingStatus");

    let currentUser = null;
    let typingTimeout = null;

    auth.onAuthStateChanged(user => {
      if (user && user.email.endsWith("@diu.edu.bd")) {
        currentUser = user;
        userName.textContent = `Welcome, ${user.displayName}`;
        signInBtn.classList.add("hidden");
        chatApp.classList.remove("hidden");
        listenToMessages();
        listenToTyping();
      } else {
        auth.signOut();
        signInBtn.classList.remove("hidden");
        chatApp.classList.add("hidden");
      }
    });

    signInBtn.addEventListener("click", () => {
      auth.signInWithPopup(provider);
    });

    logoutBtn.addEventListener("click", () => {
      auth.signOut();
    });

    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (text) {
        await db.collection("messages").add({
          text,
          name: currentUser.displayName,
          uid: currentUser.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        messageInput.value = "";
        updateTyping(false);
      }
    });

    messageInput.addEventListener("input", () => {
      updateTyping(true);
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => updateTyping(false), 2000);
    });

    function updateTyping(isTyping) {
      if (currentUser) {
        db.collection("typing").doc(currentUser.uid).set({
          name: currentUser.displayName,
          isTyping,
          timestamp: Date.now()
        });
      }
    }

    function listenToMessages() {
      db.collection("messages").orderBy("createdAt").onSnapshot(snapshot => {
        messagesDiv.innerHTML = "";
        snapshot.forEach(doc => {
          const msg = doc.data();
          const msgDiv = document.createElement("div");
          msgDiv.className = `p-2 rounded ${msg.uid === currentUser.uid ? "bg-green-600 text-right ml-10" : "bg-gray-700 mr-10"}`;
          msgDiv.innerHTML = `<div class="text-sm text-gray-300">${msg.name}</div><div>${addEmoji(msg.text)}</div>`;
          messagesDiv.appendChild(msgDiv);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    function addEmoji(text) {
      return text.replace(/:smile:/g, "😄")
                 .replace(/:heart:/g, "❤️")
                 .replace(/:fire:/g, "🔥")
                 .replace(/:thumbsup:/g, "👍");
    }

    function listenToTyping() {
      db.collection("typing").onSnapshot(snapshot => {
        let typingUsers = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.uid !== currentUser?.uid && data.isTyping) {
            typingUsers.push(data.name);
          }
        });
        typingStatus.textContent = typingUsers.length ? `${typingUsers.join(", ")} is typing...` : \"\";
      });
    }
  </script>
</body>
</html>
